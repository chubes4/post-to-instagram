(()=>{"use strict";const e=window.wp.plugins,t=window.wp.editor,s=window.wp.i18n,a=window.wp.components,i=window.wp.element,n=window.ReactJSXRuntime,o=({isConfigured:e,isAuthenticated:t,authUrl:o,i18n:r,isLoading:c,onAuthStatusChange:d,showEdit:l,setShowEdit:u,savedAppId:p})=>{const[h,g]=(0,i.useState)(p||""),[m,_]=(0,i.useState)(""),[w,x]=(0,i.useState)(null),[f,S]=(0,i.useState)(!1),[j,v]=(0,i.useState)(!1);return(0,i.useEffect)((()=>{l&&p&&g(p),l&&(_(""),v(!0),wp.apiFetch({path:"pti/v1/auth/status",method:"GET"}).then((e=>{g(e.app_id||""),v(!1)})))}),[l,p]),!e||l?(0,n.jsxs)("form",{onSubmit:e=>{e.preventDefault(),S(!0),x(null),wp.apiFetch({path:"pti/v1/auth/credentials",method:"POST",data:{app_id:h,app_secret:m}}).then((e=>{S(!1),e.success?(x({status:"success",message:r.creds_saved||"Credentials saved."}),g(""),_(""),u&&u(!1),d&&d()):x({status:"error",message:e.message||r.error_saving_creds||"Error saving credentials."})})).catch((e=>{S(!1),x({status:"error",message:e&&e.message||r.error_saving_creds||"Error saving credentials."})}))},children:[(0,n.jsx)("p",{children:r.not_configured_for_auth||"App ID and Secret are not configured."}),(0,n.jsx)(a.TextControl,{label:r.app_id_label||"Instagram App ID",value:h,onChange:g,disabled:f||j,__next40pxDefaultSize:!0,__nextHasNoMarginBottom:!0}),(0,n.jsx)(a.TextControl,{label:r.app_secret_label||"Instagram App Secret",value:m,onChange:_,type:"password",disabled:f||j,__next40pxDefaultSize:!0,__nextHasNoMarginBottom:!0}),(0,n.jsx)("p",{style:{fontSize:"smaller",color:"#666",marginTop:0},children:(0,s.__)("For security, the App Secret is never shown. Please re-enter it to update your credentials.","post-to-instagram")}),(0,n.jsx)(a.Button,{isPrimary:!0,type:"submit",disabled:f||!h||!m||j,children:r.save_credentials||"Save Credentials"}),e&&u&&(0,n.jsx)(a.Button,{isSecondary:!0,onClick:()=>{u(!1),x(null)},disabled:f||j,style:{marginLeft:8},children:(0,s.__)("Cancel","post-to-instagram")}),j&&(0,n.jsx)("p",{children:(0,s.__)("Loading App ID...","post-to-instagram")}),w&&(0,n.jsx)(a.Notice,{status:w.status,isDismissible:!0,onRemove:()=>x(null),children:w.message})]}):null},r=({allowedIds:e=[],selectedImages:t=[],setSelectedImages:o,onClose:r,maxSelect:c=10})=>{const[d,l]=(0,i.useState)([]),[u,p]=(0,i.useState)(!0),[h,g]=(0,i.useState)(null),[m,_]=(0,i.useState)(t.map((e=>e.id))),[w,x]=(0,i.useState)(null);return(0,i.useEffect)((()=>{p(!0),(async e=>{if(!e.length)return[];const t=e.map((e=>`include[]=${e}`)).join("&"),s=await fetch(`/wp-json/wp/v2/media?per_page=100&${t}`);return s.ok?await s.json():[]})(e).then((e=>{l(e),p(!1)})).catch((()=>{g((0,s.__)("Failed to load images.","post-to-instagram")),p(!1)}))}),[e&&e.join(",")]),(0,n.jsxs)(a.Modal,{title:(0,s.__)("Select Images for Instagram","post-to-instagram"),onRequestClose:r,shouldCloseOnClickOutside:!1,children:[u&&(0,n.jsx)(a.Spinner,{}),h&&(0,n.jsx)(a.Notice,{status:"error",isDismissible:!1,children:h}),w&&(0,n.jsx)(a.Notice,{status:w.status,isDismissible:!0,onRemove:()=>x(null),children:w.message}),!u&&!h&&(0,n.jsx)("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(120px, 1fr))",gap:16,marginBottom:24},children:d.map((e=>(0,n.jsxs)(a.Card,{isSelected:m.includes(e.id),onClick:()=>(e=>{if(m.includes(e))_(m.filter((t=>t!==e)));else{if(m.length>=c)return void x({status:"error",message:(0,s.__)("You can select a maximum of 10 images.","post-to-instagram")});_([...m,e])}})(e.id),style:{cursor:"pointer",border:m.includes(e.id)?"2px solid #007cba":"1px solid #ddd"},children:[(0,n.jsx)(a.CardMedia,{children:(0,n.jsx)("img",{src:e.media_details?.sizes?.thumbnail?.source_url||e.source_url,alt:e.alt_text||"",style:{width:"100%",height:80,objectFit:"cover",borderRadius:4}})}),(0,n.jsxs)(a.CardBody,{children:[(0,n.jsx)("input",{type:"checkbox",checked:m.includes(e.id),readOnly:!0,style:{marginRight:8}}),e.title?.rendered||(0,s.__)("Image","post-to-instagram")]})]},e.id)))}),(0,n.jsxs)("div",{style:{display:"flex",justifyContent:"flex-end",gap:8},children:[(0,n.jsx)(a.Button,{isSecondary:!0,onClick:r,children:(0,s.__)("Cancel","post-to-instagram")}),(0,n.jsx)(a.Button,{isPrimary:!0,onClick:()=>{const e=d.filter((e=>m.includes(e.id))).map((e=>({id:e.id,url:e.source_url,alt:e.alt_text,width:e.media_details?.width,height:e.media_details?.height})));o(e),r&&r()},disabled:!m.length,children:(0,s.__)("Select","post-to-instagram")})]})]})},c=e=>({width:48,height:48/e,objectFit:"cover",borderRadius:4,border:"1px solid #ccc",cursor:"pointer",background:"#fff"}),d=({images:e,setImages:t,aspectRatio:s,onPreview:a})=>{const o=(0,i.useRef)(),r=(0,i.useRef)(),d=()=>{const s=o.current,a=r.current;if(void 0===s||void 0===a||s===a)return;const i=[...e],[n]=i.splice(s,1);i.splice(a,0,n),t(i),o.current=void 0,r.current=void 0};return e.length?(0,n.jsx)("div",{style:{display:"flex",flexWrap:"wrap",gap:8,marginTop:8},children:e.map(((e,t)=>(0,n.jsx)("img",{src:e.url,alt:e.alt||"",style:c(s),draggable:!0,onDragStart:()=>{return e=t,void(o.current=e);var e},onDragEnter:()=>{return e=t,void(r.current=e);var e},onDragEnd:d,onClick:()=>a&&a(t),title:"Drag to reorder. Click to preview."},e.id)))}):null};window.wp.notices;const l="instagram";(0,e.registerPlugin)("post-to-instagram",{render:()=>{const{is_configured:e,is_authenticated:c,auth_url:u,i18n:p,auth_redirect_status:h,app_id:g,post_id:m}=pti_data,[_,w]=(0,i.useState)(e),[x,f]=(0,i.useState)(c),[S,j]=(0,i.useState)(u),[v,b]=(0,i.useState)(!0),[y,C]=(0,i.useState)(!1),[I,k]=(0,i.useState)(g||""),[E,P]=(0,i.useState)([]),[D,A]=(0,i.useState)(!1),[N,B]=(0,i.useState)(null),[R,F]=(0,i.useState)([]),[L,T]=(0,i.useState)(""),[O,W]=(0,i.useState)(!1),[M,z]=(0,i.useState)(!1),U=E.length>0&&E[0].url&&E[0].id?(()=>{const e=E[0];return e.width&&e.height?e.width/e.height:1})():1,$=(e=!1)=>{b(!0),wp.apiFetch({path:"pti/v1/auth/status",method:"GET"}).then((t=>{w(t.is_configured),f(t.is_authenticated),j(t.auth_url||"#"),k(t.app_id||""),b(!1),e&&t.is_authenticated})).catch((t=>{b(!1),console.error("Error checking auth status:",t),e&&alert(p.generic_auth_error||"Error checking authentication status.")}))};(0,i.useEffect)((()=>{const e=e=>{e.data&&"pti_auth_complete"===e.data.type&&(e.data.success?($(!0),window.oauthWindow&&!window.oauthWindow.closed&&window.oauthWindow.close()):alert(p.auth_failed+(e.data.message?"\\n"+e.data.message:"")))};return window.addEventListener("message",e),()=>window.removeEventListener("message",e)}),[p]),(0,i.useEffect)((()=>{if(h){if("success"===h)$(!0);else{let e=p.auth_failed;p[h]?e=p[h]:"1"!==h&&(e+=` (Details: ${h})`),alert(e)}if(window.history.replaceState){const e=new URL(window.location.href);e.searchParams.delete("pti_auth_success"),e.searchParams.delete("pti_auth_error"),window.history.replaceState({path:e.href},"",e.href)}}}),[h,p]);(0,i.useEffect)((()=>{$()}),[]);let q;return q=v?(0,n.jsx)("p",{children:(0,s.__)("Loading status...","post-to-instagram")}):!_||y?(0,n.jsx)(o,{isConfigured:_,isAuthenticated:x,authUrl:S,i18n:p,isLoading:v,onAuthStatusChange:$,showEdit:y,setShowEdit:C,savedAppId:I}):x?(0,n.jsxs)(i.Fragment,{children:[(0,n.jsx)("p",{children:(0,s.__)("Ready to post to Instagram!","post-to-instagram")}),(0,n.jsx)(a.Button,{isPrimary:!0,onClick:()=>{F(function(){if(!window.wp||!window.wp.data||!window.wp.data.select)return[];try{const e=window.wp.data.select("core/block-editor").getBlocks();let t=[];const s=e=>{e.forEach((e=>{"core/image"===e.name&&e.attributes&&e.attributes.id&&t.push(Number(e.attributes.id)),e.innerBlocks&&e.innerBlocks.length&&s(e.innerBlocks)}))};return s(e),Array.from(new Set(t))}catch(e){return[]}}()),A(!0)},children:p.select_images||"Select Images"}),(0,n.jsx)("div",{className:"pti-cropping-notice",children:(0,s.__)("All images will be cropped to match the aspect ratio of the first image in your selection, per Instagram's requirements.","post-to-instagram")}),(0,n.jsx)(d,{images:E,setImages:P,aspectRatio:U,onPreview:e=>B(e)}),E.length>0&&(0,n.jsxs)("div",{className:"pti-caption-box",children:[(0,n.jsx)("label",{className:"pti-caption-label",children:(0,s.__)("Instagram Caption","post-to-instagram")}),(0,n.jsx)("textarea",{className:"pti-caption-input",value:L,onChange:e=>T(e.target.value),rows:4,placeholder:(0,s.__)("Write your Instagram caption here...","post-to-instagram")}),(0,n.jsxs)("div",{className:"pti-post-actions",children:[(0,n.jsx)(a.Button,{isPrimary:!0,onClick:async()=>{if(E.length){W(!0);try{const e=await wp.apiFetch({path:"/pti/v1/post-now",method:"POST",data:{post_id:m,image_ids:E.map((e=>e.id)),caption:L,_wpnonce:pti_data.nonce_post_media}});W(!1),e&&e.success?(P([]),T(""),wp.data.dispatch("core/notices").createNotice("success",(0,s.__)("Posted to Instagram successfully!","post-to-instagram"),{isDismissible:!0})):wp.data.dispatch("core/notices").createNotice("error",e&&e.message?e.message:(0,s.__)("Failed to post to Instagram.","post-to-instagram"),{isDismissible:!0})}catch(e){W(!1),wp.data.dispatch("core/notices").createNotice("error",(0,s.__)("Error posting to Instagram.","post-to-instagram"),{isDismissible:!0})}}},disabled:O,children:O?(0,s.__)("Posting...","post-to-instagram"):(0,s.__)("Post Now","post-to-instagram")}),(0,n.jsx)(a.Button,{isSecondary:!0,children:(0,s.__)("Schedule Post","post-to-instagram")})]})]}),null!==N&&(0,n.jsx)("div",{className:"pti-preview-placeholder",children:(0,s.__)("(Image preview modal coming soon)","post-to-instagram")}),D&&(0,n.jsx)(r,{allowedIds:R,selectedImages:E,setSelectedImages:P,onClose:()=>A(!1),maxSelect:10})]}):(0,n.jsxs)(i.Fragment,{children:[(0,n.jsx)("p",{children:(0,s.__)("Connect your Instagram account to start posting.","post-to-instagram")}),(0,n.jsx)(a.Button,{isPrimary:!0,onClick:()=>{if(_)if(S&&"#"!==S){window.oauthWindow=window.open(S,"ptiOAuthConnect","width=600,height=700");const e=setInterval((()=>{window.oauthWindow&&window.oauthWindow.closed&&(clearInterval(e),console.log("OAuth window closed by user or completed, re-checking auth status."),$(!0))}),1e3)}else alert(p.generic_auth_error||"Authentication URL not available.");else alert(p.not_configured_for_auth||"App not configured.")},disabled:v||"#"===S,children:p.connect_instagram||"Connect to Instagram"}),(0,n.jsx)(a.Button,{isSecondary:!0,onClick:()=>C(!0),style:{marginLeft:8},children:(0,s.__)("Edit API Credentials","post-to-instagram")})]}),(0,n.jsxs)(i.Fragment,{children:[(0,n.jsx)(t.PluginSidebarMoreMenuItem,{target:"post-to-instagram-sidebar",icon:l,children:p.post_to_instagram||"Post to Instagram"}),(0,n.jsxs)(t.PluginSidebar,{name:"post-to-instagram-sidebar",title:p.post_to_instagram||"Post to Instagram",icon:l,children:[(0,n.jsx)(a.PanelBody,{children:q}),(0,n.jsx)("div",{className:"pti-disconnect-bottom",children:(0,n.jsx)(a.Button,{isSecondary:!0,onClick:async()=>{if(window.confirm(p.disconnect_instagram||"Disconnect Instagram Account?")){z(!0);try{const e=await wp.apiFetch({path:"/pti/v1/disconnect",method:"POST",data:{_wpnonce:pti_data.nonce_disconnect}});z(!1),e&&e.success?(wp.data.dispatch("core/notices").createNotice("success",p.disconnected||"Account disconnected.",{isDismissible:!0}),$()):wp.data.dispatch("core/notices").createNotice("error",e&&e.message?e.message:p.error_disconnecting||"Error disconnecting account.",{isDismissible:!0})}catch(e){z(!1),wp.data.dispatch("core/notices").createNotice("error",p.error_disconnecting||"Error disconnecting account.",{isDismissible:!0})}}},disabled:M,children:M?(0,s.__)("Disconnecting...","post-to-instagram"):p.disconnect_instagram||"Disconnect"})})]})]})},icon:l})})();
//# sourceMappingURL=post-editor.js.map