(()=>{"use strict";const e=window.wp.plugins,t=window.wp.editor,a=window.wp.i18n,s=window.wp.components,n=window.wp.element,r=window.ReactJSXRuntime,i=({isConfigured:e,isAuthenticated:t,authUrl:i,i18n:o,isLoading:c,onAuthStatusChange:d,showEdit:l,setShowEdit:u,savedAppId:p})=>{const[g,h]=(0,n.useState)(p||""),[m,w]=(0,n.useState)(""),[_,f]=(0,n.useState)(null),[S,v]=(0,n.useState)(!1),[x,y]=(0,n.useState)(!1);return(0,n.useEffect)((()=>{l&&p&&h(p),l&&(w(""),y(!0),wp.apiFetch({path:"pti/v1/auth/status",method:"GET"}).then((e=>{h(e.app_id||""),y(!1)})))}),[l,p]),!e||l?(0,r.jsxs)("form",{onSubmit:e=>{e.preventDefault(),v(!0),f(null),wp.apiFetch({path:"pti/v1/auth/credentials",method:"POST",data:{app_id:g,app_secret:m}}).then((e=>{v(!1),e.success?(f({status:"success",message:o.creds_saved||"Credentials saved."}),h(""),w(""),u&&u(!1),d&&d()):f({status:"error",message:e.message||o.error_saving_creds||"Error saving credentials."})})).catch((e=>{v(!1),f({status:"error",message:e&&e.message||o.error_saving_creds||"Error saving credentials."})}))},children:[(0,r.jsx)("p",{children:o.not_configured_for_auth||"App ID and Secret are not configured."}),(0,r.jsx)(s.TextControl,{label:o.app_id_label||"Instagram App ID",value:g,onChange:h,disabled:S||x,__next40pxDefaultSize:!0,__nextHasNoMarginBottom:!0}),(0,r.jsx)(s.TextControl,{label:o.app_secret_label||"Instagram App Secret",value:m,onChange:w,type:"password",disabled:S||x,__next40pxDefaultSize:!0,__nextHasNoMarginBottom:!0}),(0,r.jsx)("p",{style:{fontSize:"smaller",color:"#666",marginTop:0},children:(0,a.__)("For security, the App Secret is never shown. Please re-enter it to update your credentials.","post-to-instagram")}),(0,r.jsx)(s.Button,{isPrimary:!0,type:"submit",disabled:S||!g||!m||x,children:o.save_credentials||"Save Credentials"}),e&&u&&(0,r.jsx)(s.Button,{isSecondary:!0,onClick:()=>{u(!1),f(null)},disabled:S||x,style:{marginLeft:8},children:(0,a.__)("Cancel","post-to-instagram")}),x&&(0,r.jsx)("p",{children:(0,a.__)("Loading App ID...","post-to-instagram")}),_&&(0,r.jsx)(s.Notice,{status:_.status,isDismissible:!0,onRemove:()=>f(null),children:_.message})]}):null},o=({selectedImages:e,setSelectedImages:t,postId:s,onClose:r})=>{const i=(0,n.useRef)(null),o=(()=>{if(!window.wp||!window.wp.data||!window.wp.data.select)return null;try{const e=window.wp.data.select("core/block-editor").getBlocks();let t=[];return e.forEach((e=>{"core/image"===e.name&&e.attributes&&e.attributes.id&&t.push(e.attributes.id),"core/gallery"===e.name&&e.attributes&&Array.isArray(e.attributes.ids)&&(t=t.concat(e.attributes.ids))})),Array.from(new Set(t.map(Number)))}catch(e){return null}})(),c=o&&o.length?o:window.pti_data&&window.pti_data.content_image_ids||[];return(0,n.useEffect)((()=>{if(!window.wp||!window.wp.media)return;if(!c.length)return alert((0,a.__)("No images found in this post. Please add images to the post content or set a featured image.","post-to-instagram")),void(r&&r());if(i.current)return void i.current.open();const s=wp.media({title:(0,a.__)("Select Images for Instagram","post-to-instagram"),library:{type:"image",query:c.length?{include:c}:{}},multiple:!0,button:{text:(0,a.__)("Select","post-to-instagram")}});return i.current=s,s.on("select",(()=>{const e=s.state().get("selection").toArray().slice(0,10).map((e=>({id:e.id,url:e.get("url"),alt:e.get("alt"),width:e.get("width"),height:e.get("height")})));t(e),r&&r()})),s.on("open",(()=>{const t=s.state().get("selection");t.reset(),e&&e.length&&e.map((e=>wp.media.attachment(e.id))).forEach((e=>t.add(e)))})),s.on("close",(()=>{r&&r()})),s.open(),()=>{i.current&&(i.current.off("select"),i.current.off("open"),i.current.off("close"),i.current=null)}}),[c&&c.join(",")]),null},c=e=>({width:48,height:48/e,objectFit:"cover",borderRadius:4,border:"1px solid #ccc",cursor:"pointer",background:"#fff"}),d=({images:e,setImages:t,aspectRatio:a,onPreview:s})=>{const i=(0,n.useRef)(),o=(0,n.useRef)(),d=()=>{const a=i.current,s=o.current;if(void 0===a||void 0===s||a===s)return;const n=[...e],[r]=n.splice(a,1);n.splice(s,0,r),t(n),i.current=void 0,o.current=void 0};return e.length?(0,r.jsx)("div",{style:{display:"flex",flexWrap:"wrap",gap:8,marginTop:8},children:e.map(((e,t)=>(0,r.jsx)("img",{src:e.url,alt:e.alt||"",style:c(a),draggable:!0,onDragStart:()=>{return e=t,void(i.current=e);var e},onDragEnter:()=>{return e=t,void(o.current=e);var e},onDragEnd:d,onClick:()=>s&&s(t),title:"Drag to reorder. Click to preview."},e.id)))}):null},l="instagram";(0,e.registerPlugin)("post-to-instagram",{render:()=>{const{is_configured:e,is_authenticated:c,auth_url:u,i18n:p,auth_redirect_status:g,app_id:h,post_id:m}=pti_data,[w,_]=(0,n.useState)(e),[f,S]=(0,n.useState)(c),[v,x]=(0,n.useState)(u),[y,b]=(0,n.useState)(!0),[j,I]=(0,n.useState)(!1),[C,E]=(0,n.useState)(h||""),[A,P]=(0,n.useState)([]),[D,k]=(0,n.useState)(!1),[R,B]=(0,n.useState)(null),L=A.length>0&&A[0].url&&A[0].id?(()=>{const e=A[0];return e.width&&e.height?e.width/e.height:1})():1,T=(e=!1)=>{b(!0),wp.apiFetch({path:"pti/v1/auth/status",method:"GET"}).then((t=>{_(t.is_configured),S(t.is_authenticated),x(t.auth_url||"#"),E(t.app_id||""),b(!1),e&&t.is_authenticated})).catch((t=>{b(!1),console.error("Error checking auth status:",t),e&&alert(p.generic_auth_error||"Error checking authentication status.")}))};(0,n.useEffect)((()=>{const e=e=>{e.data&&"pti_auth_complete"===e.data.type&&(e.data.success?(T(!0),window.oauthWindow&&!window.oauthWindow.closed&&window.oauthWindow.close()):alert(p.auth_failed+(e.data.message?"\\n"+e.data.message:"")))};return window.addEventListener("message",e),()=>window.removeEventListener("message",e)}),[p]),(0,n.useEffect)((()=>{if(g){if("success"===g)T(!0);else{let e=p.auth_failed;p[g]?e=p[g]:"1"!==g&&(e+=` (Details: ${g})`),alert(e)}if(window.history.replaceState){const e=new URL(window.location.href);e.searchParams.delete("pti_auth_success"),e.searchParams.delete("pti_auth_error"),window.history.replaceState({path:e.href},"",e.href)}}}),[g,p]);(0,n.useEffect)((()=>{T()}),[]);let F;return F=y?(0,r.jsx)("p",{children:(0,a.__)("Loading status...","post-to-instagram")}):!w||j?(0,r.jsx)(i,{isConfigured:w,isAuthenticated:f,authUrl:v,i18n:p,isLoading:y,onAuthStatusChange:T,showEdit:j,setShowEdit:I,savedAppId:C}):f?(0,r.jsxs)(n.Fragment,{children:[(0,r.jsx)("p",{children:(0,a.__)("Ready to post to Instagram!","post-to-instagram")}),(0,r.jsx)(s.Button,{isPrimary:!0,onClick:()=>k(!0),children:p.select_images||"Select Images"}),(0,r.jsx)("div",{style:{margin:"8px 0",color:"#b26a00",fontSize:12},children:(0,a.__)("All images will be cropped to match the aspect ratio of the first image in your selection, per Instagram's requirements.","post-to-instagram")}),(0,r.jsx)(d,{images:A,setImages:P,aspectRatio:L,onPreview:e=>B(e)}),null!==R&&(0,r.jsx)("div",{style:{marginTop:12,color:"#888"},children:(0,a.__)("(Image preview modal coming soon)","post-to-instagram")}),(0,r.jsx)(s.Button,{isSecondary:!0,onClick:()=>alert("Disconnect TBD"),style:{marginLeft:8},children:p.disconnect_instagram||"Disconnect"}),D&&(0,r.jsx)(o,{selectedImages:A,setSelectedImages:P,postId:m,onClose:()=>k(!1)})]}):(0,r.jsxs)(n.Fragment,{children:[(0,r.jsx)("p",{children:(0,a.__)("Connect your Instagram account to start posting.","post-to-instagram")}),(0,r.jsx)(s.Button,{isPrimary:!0,onClick:()=>{if(w)if(v&&"#"!==v){window.oauthWindow=window.open(v,"ptiOAuthConnect","width=600,height=700");const e=setInterval((()=>{window.oauthWindow&&window.oauthWindow.closed&&(clearInterval(e),console.log("OAuth window closed by user or completed, re-checking auth status."),T(!0))}),1e3)}else alert(p.generic_auth_error||"Authentication URL not available.");else alert(p.not_configured_for_auth||"App not configured.")},disabled:y||"#"===v,children:p.connect_instagram||"Connect to Instagram"}),(0,r.jsx)(s.Button,{isSecondary:!0,onClick:()=>I(!0),style:{marginLeft:8},children:(0,a.__)("Edit API Credentials","post-to-instagram")})]}),(0,r.jsxs)(n.Fragment,{children:[(0,r.jsx)(t.PluginSidebarMoreMenuItem,{target:"post-to-instagram-sidebar",icon:l,children:p.post_to_instagram||"Post to Instagram"}),(0,r.jsx)(t.PluginSidebar,{name:"post-to-instagram-sidebar",title:p.post_to_instagram||"Post to Instagram",icon:l,children:(0,r.jsx)(s.PanelBody,{children:F})})]})},icon:l})})();
//# sourceMappingURL=post-editor.js.map