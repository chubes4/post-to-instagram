(()=>{"use strict";const t=window.wp.plugins,e=window.wp.editor,a=window.wp.i18n,s=window.wp.components,n=window.wp.element,r=window.ReactJSXRuntime,i=({isConfigured:t,isAuthenticated:e,authUrl:i,i18n:o,isLoading:d,onAuthStatusChange:c,showEdit:l,setShowEdit:u,savedAppId:p})=>{const[g,h]=(0,n.useState)(p||""),[m,w]=(0,n.useState)(""),[_,f]=(0,n.useState)(null),[S,v]=(0,n.useState)(!1),[x,b]=(0,n.useState)(!1);return(0,n.useEffect)((()=>{l&&p&&h(p),l&&(w(""),b(!0),wp.apiFetch({path:"pti/v1/auth/status",method:"GET"}).then((t=>{h(t.app_id||""),b(!1)})))}),[l,p]),!t||l?(0,r.jsxs)("form",{onSubmit:t=>{t.preventDefault(),v(!0),f(null),wp.apiFetch({path:"pti/v1/auth/credentials",method:"POST",data:{app_id:g,app_secret:m}}).then((t=>{v(!1),t.success?(f({status:"success",message:o.creds_saved||"Credentials saved."}),h(""),w(""),u&&u(!1),c&&c()):f({status:"error",message:t.message||o.error_saving_creds||"Error saving credentials."})})).catch((t=>{v(!1),f({status:"error",message:t&&t.message||o.error_saving_creds||"Error saving credentials."})}))},children:[(0,r.jsx)("p",{children:o.not_configured_for_auth||"App ID and Secret are not configured."}),(0,r.jsx)(s.TextControl,{label:o.app_id_label||"Instagram App ID",value:g,onChange:h,disabled:S||x,__next40pxDefaultSize:!0,__nextHasNoMarginBottom:!0}),(0,r.jsx)(s.TextControl,{label:o.app_secret_label||"Instagram App Secret",value:m,onChange:w,type:"password",disabled:S||x,__next40pxDefaultSize:!0,__nextHasNoMarginBottom:!0}),(0,r.jsx)("p",{style:{fontSize:"smaller",color:"#666",marginTop:0},children:(0,a.__)("For security, the App Secret is never shown. Please re-enter it to update your credentials.","post-to-instagram")}),(0,r.jsx)(s.Button,{isPrimary:!0,type:"submit",disabled:S||!g||!m||x,children:o.save_credentials||"Save Credentials"}),t&&u&&(0,r.jsx)(s.Button,{isSecondary:!0,onClick:()=>{u(!1),f(null)},disabled:S||x,style:{marginLeft:8},children:(0,a.__)("Cancel","post-to-instagram")}),x&&(0,r.jsx)("p",{children:(0,a.__)("Loading App ID...","post-to-instagram")}),_&&(0,r.jsx)(s.Notice,{status:_.status,isDismissible:!0,onRemove:()=>f(null),children:_.message})]}):null},o=({selectedImages:t,setSelectedImages:e,postId:s,onClose:r})=>{const i=(0,n.useRef)(null),o=(()=>{if(!window.wp||!window.wp.data||!window.wp.data.select)return null;try{const t=window.wp.data.select("core/block-editor").getBlocks();let e=[];return t.forEach((t=>{"core/image"===t.name&&t.attributes&&t.attributes.id&&e.push(t.attributes.id),"core/gallery"===t.name&&t.attributes&&Array.isArray(t.attributes.ids)&&(e=e.concat(t.attributes.ids))})),Array.from(new Set(e.map(Number)))}catch(t){return null}})(),d=o&&o.length?o:window.pti_data&&window.pti_data.content_image_ids||[];return(0,n.useEffect)((()=>{if(!window.wp||!window.wp.media)return;if(!d.length)return alert((0,a.__)("No images found in this post. Please add images to the post content or set a featured image.","post-to-instagram")),void(r&&r());if(i.current)return void i.current.open();const s=wp.media({title:(0,a.__)("Select Images for Instagram","post-to-instagram"),library:{type:"image",filter:t=>d.includes(t.id)},multiple:!0,button:{text:(0,a.__)("Select","post-to-instagram")}});return i.current=s,s.on("select",(()=>{const t=s.state().get("selection").toArray().slice(0,10).map((t=>({id:t.id,url:t.get("url"),alt:t.get("alt"),width:t.get("width"),height:t.get("height")})));e(t),r&&r()})),s.on("open",(()=>{const e=s.state().get("selection");e.reset(),t&&t.length&&t.map((t=>wp.media.attachment(t.id))).forEach((t=>e.add(t)))})),s.on("close",(()=>{r&&r()})),s.open(),()=>{i.current&&(i.current.off("select"),i.current.off("open"),i.current.off("close"),i.current=null)}}),[d&&d.join(",")]),null},d=t=>({width:48,height:48/t,objectFit:"cover",borderRadius:4,border:"1px solid #ccc",cursor:"pointer",background:"#fff"}),c=({images:t,setImages:e,aspectRatio:a,onPreview:s})=>{const i=(0,n.useRef)(),o=(0,n.useRef)(),c=()=>{const a=i.current,s=o.current;if(void 0===a||void 0===s||a===s)return;const n=[...t],[r]=n.splice(a,1);n.splice(s,0,r),e(n),i.current=void 0,o.current=void 0};return t.length?(0,r.jsx)("div",{style:{display:"flex",flexWrap:"wrap",gap:8,marginTop:8},children:t.map(((t,e)=>(0,r.jsx)("img",{src:t.url,alt:t.alt||"",style:d(a),draggable:!0,onDragStart:()=>{return t=e,void(i.current=t);var t},onDragEnter:()=>{return t=e,void(o.current=t);var t},onDragEnd:c,onClick:()=>s&&s(e),title:"Drag to reorder. Click to preview."},t.id)))}):null},l="instagram";(0,t.registerPlugin)("post-to-instagram",{render:()=>{const{is_configured:t,is_authenticated:d,auth_url:u,i18n:p,auth_redirect_status:g,app_id:h,post_id:m}=pti_data,[w,_]=(0,n.useState)(t),[f,S]=(0,n.useState)(d),[v,x]=(0,n.useState)(u),[b,y]=(0,n.useState)(!0),[j,I]=(0,n.useState)(!1),[C,E]=(0,n.useState)(h||""),[A,P]=(0,n.useState)([]),[D,k]=(0,n.useState)(!1),[R,B]=(0,n.useState)(null),L=A.length>0&&A[0].url&&A[0].id?(()=>{const t=A[0];return t.width&&t.height?t.width/t.height:1})():1,T=(t=!1)=>{y(!0),wp.apiFetch({path:"pti/v1/auth/status",method:"GET"}).then((e=>{_(e.is_configured),S(e.is_authenticated),x(e.auth_url||"#"),E(e.app_id||""),y(!1),t&&e.is_authenticated})).catch((e=>{y(!1),console.error("Error checking auth status:",e),t&&alert(p.generic_auth_error||"Error checking authentication status.")}))};(0,n.useEffect)((()=>{const t=t=>{t.data&&"pti_auth_complete"===t.data.type&&(t.data.success?(T(!0),window.oauthWindow&&!window.oauthWindow.closed&&window.oauthWindow.close()):alert(p.auth_failed+(t.data.message?"\\n"+t.data.message:"")))};return window.addEventListener("message",t),()=>window.removeEventListener("message",t)}),[p]),(0,n.useEffect)((()=>{if(g){if("success"===g)T(!0);else{let t=p.auth_failed;p[g]?t=p[g]:"1"!==g&&(t+=` (Details: ${g})`),alert(t)}if(window.history.replaceState){const t=new URL(window.location.href);t.searchParams.delete("pti_auth_success"),t.searchParams.delete("pti_auth_error"),window.history.replaceState({path:t.href},"",t.href)}}}),[g,p]);(0,n.useEffect)((()=>{T()}),[]);let F;return F=b?(0,r.jsx)("p",{children:(0,a.__)("Loading status...","post-to-instagram")}):!w||j?(0,r.jsx)(i,{isConfigured:w,isAuthenticated:f,authUrl:v,i18n:p,isLoading:b,onAuthStatusChange:T,showEdit:j,setShowEdit:I,savedAppId:C}):f?(0,r.jsxs)(n.Fragment,{children:[(0,r.jsx)("p",{children:(0,a.__)("Ready to post to Instagram!","post-to-instagram")}),(0,r.jsx)(s.Button,{isPrimary:!0,onClick:()=>k(!0),children:p.select_images||"Select Images"}),(0,r.jsx)("div",{style:{margin:"8px 0",color:"#b26a00",fontSize:12},children:(0,a.__)("All images will be cropped to match the aspect ratio of the first image in your selection, per Instagram's requirements.","post-to-instagram")}),(0,r.jsx)(c,{images:A,setImages:P,aspectRatio:L,onPreview:t=>B(t)}),null!==R&&(0,r.jsx)("div",{style:{marginTop:12,color:"#888"},children:(0,a.__)("(Image preview modal coming soon)","post-to-instagram")}),(0,r.jsx)(s.Button,{isSecondary:!0,onClick:()=>alert("Disconnect TBD"),style:{marginLeft:8},children:p.disconnect_instagram||"Disconnect"}),D&&(0,r.jsx)(o,{selectedImages:A,setSelectedImages:P,postId:m,onClose:()=>k(!1)})]}):(0,r.jsxs)(n.Fragment,{children:[(0,r.jsx)("p",{children:(0,a.__)("Connect your Instagram account to start posting.","post-to-instagram")}),(0,r.jsx)(s.Button,{isPrimary:!0,onClick:()=>{if(w)if(v&&"#"!==v){window.oauthWindow=window.open(v,"ptiOAuthConnect","width=600,height=700");const t=setInterval((()=>{window.oauthWindow&&window.oauthWindow.closed&&(clearInterval(t),console.log("OAuth window closed by user or completed, re-checking auth status."),T(!0))}),1e3)}else alert(p.generic_auth_error||"Authentication URL not available.");else alert(p.not_configured_for_auth||"App not configured.")},disabled:b||"#"===v,children:p.connect_instagram||"Connect to Instagram"}),(0,r.jsx)(s.Button,{isSecondary:!0,onClick:()=>I(!0),style:{marginLeft:8},children:(0,a.__)("Edit API Credentials","post-to-instagram")})]}),(0,r.jsxs)(n.Fragment,{children:[(0,r.jsx)(e.PluginSidebarMoreMenuItem,{target:"post-to-instagram-sidebar",icon:l,children:p.post_to_instagram||"Post to Instagram"}),(0,r.jsx)(e.PluginSidebar,{name:"post-to-instagram-sidebar",title:p.post_to_instagram||"Post to Instagram",icon:l,children:(0,r.jsx)(s.PanelBody,{children:F})})]})},icon:l})})();
//# sourceMappingURL=post-editor.js.map