(()=>{"use strict";const t=window.wp.plugins,e=window.wp.editor,a=window.wp.i18n,s=window.wp.components,r=window.wp.element,i=window.ReactJSXRuntime,n=({isConfigured:t,isAuthenticated:e,authUrl:n,i18n:o,isLoading:d,onAuthStatusChange:l,showEdit:c,setShowEdit:u,savedAppId:p})=>{const[g,h]=(0,r.useState)(p||""),[m,w]=(0,r.useState)(""),[_,f]=(0,r.useState)(null),[x,v]=(0,r.useState)(!1),[S,y]=(0,r.useState)(!1);return(0,r.useEffect)((()=>{c&&p&&h(p),c&&(w(""),y(!0),wp.apiFetch({path:"pti/v1/auth/status",method:"GET"}).then((t=>{h(t.app_id||""),y(!1)})))}),[c,p]),!t||c?(0,i.jsxs)("form",{onSubmit:t=>{t.preventDefault(),v(!0),f(null),wp.apiFetch({path:"pti/v1/auth/credentials",method:"POST",data:{app_id:g,app_secret:m}}).then((t=>{v(!1),t.success?(f({status:"success",message:o.creds_saved||"Credentials saved."}),h(""),w(""),u&&u(!1),l&&l()):f({status:"error",message:t.message||o.error_saving_creds||"Error saving credentials."})})).catch((t=>{v(!1),f({status:"error",message:t&&t.message||o.error_saving_creds||"Error saving credentials."})}))},children:[(0,i.jsx)("p",{children:o.not_configured_for_auth||"App ID and Secret are not configured."}),(0,i.jsx)(s.TextControl,{label:o.app_id_label||"Instagram App ID",value:g,onChange:h,disabled:x||S,__next40pxDefaultSize:!0,__nextHasNoMarginBottom:!0}),(0,i.jsx)(s.TextControl,{label:o.app_secret_label||"Instagram App Secret",value:m,onChange:w,type:"password",disabled:x||S,__next40pxDefaultSize:!0,__nextHasNoMarginBottom:!0}),(0,i.jsx)("p",{style:{fontSize:"smaller",color:"#666",marginTop:0},children:(0,a.__)("For security, the App Secret is never shown. Please re-enter it to update your credentials.","post-to-instagram")}),(0,i.jsx)(s.Button,{isPrimary:!0,type:"submit",disabled:x||!g||!m||S,children:o.save_credentials||"Save Credentials"}),t&&u&&(0,i.jsx)(s.Button,{isSecondary:!0,onClick:()=>{u(!1),f(null)},disabled:x||S,style:{marginLeft:8},children:(0,a.__)("Cancel","post-to-instagram")}),S&&(0,i.jsx)("p",{children:(0,a.__)("Loading App ID...","post-to-instagram")}),_&&(0,i.jsx)(s.Notice,{status:_.status,isDismissible:!0,onRemove:()=>f(null),children:_.message})]}):null},o=({selectedImages:t,setSelectedImages:e,postId:s,onClose:i})=>{const n=(0,r.useRef)(null),o=(()=>{if(!window.wp||!window.wp.data||!window.wp.data.select)return null;try{const t=window.wp.data.select("core/block-editor").getBlocks();let e=[];return t.forEach((t=>{"core/image"===t.name&&t.attributes&&t.attributes.id&&e.push(t.attributes.id),"core/gallery"===t.name&&t.attributes&&Array.isArray(t.attributes.ids)&&(e=e.concat(t.attributes.ids))})),Array.from(new Set(e.map(Number)))}catch(t){return null}})(),d=o&&o.length?o:window.pti_data&&window.pti_data.content_image_ids||[];return(0,r.useEffect)((()=>{if(!window.wp||!window.wp.media)return;if(!d.length)return alert((0,a.__)("No images found in this post. Please add images to the post content or set a featured image.","post-to-instagram")),void(i&&i());if(n.current)return void n.current.open();const s=wp.media({frame:"post",state:"gallery",title:(0,a.__)("Create gallery","post-to-instagram"),multiple:!0,library:{type:"image"},button:{text:(0,a.__)("Select","post-to-instagram")}});return n.current=s,s.on("ready",(()=>{const t=s.state(),e=t.get("filters");e&&!e.findWhere({prop:"ptiFilter"})&&e.add([new wp.media.model.QueryFilter({text:(0,a.__)("Images in this Post","post-to-instagram"),props:{ptiFilter:"in_this_post"},priority:100,filter:function(t){return d.includes(t.id)}})]),t.set("ptiFilter","in_this_post")})),s.on("select",(()=>{const t=s.state().get("selection").toArray().slice(0,10).map((t=>({id:t.id,url:t.get("url"),alt:t.get("alt"),width:t.get("width"),height:t.get("height")})));e(t),i&&i()})),s.on("open",(()=>{const e=s.state().get("selection");e.reset(),t&&t.length&&t.map((t=>wp.media.attachment(t.id))).forEach((t=>e.add(t)))})),s.on("close",(()=>{i&&i()})),s.open(),()=>{n.current&&(n.current.off("select"),n.current.off("open"),n.current.off("close"),n.current.off("ready"),n.current=null)}}),[d&&d.join(",")]),null},d=t=>({width:48,height:48/t,objectFit:"cover",borderRadius:4,border:"1px solid #ccc",cursor:"pointer",background:"#fff"}),l=({images:t,setImages:e,aspectRatio:a,onPreview:s})=>{const n=(0,r.useRef)(),o=(0,r.useRef)(),l=()=>{const a=n.current,s=o.current;if(void 0===a||void 0===s||a===s)return;const r=[...t],[i]=r.splice(a,1);r.splice(s,0,i),e(r),n.current=void 0,o.current=void 0};return t.length?(0,i.jsx)("div",{style:{display:"flex",flexWrap:"wrap",gap:8,marginTop:8},children:t.map(((t,e)=>(0,i.jsx)("img",{src:t.url,alt:t.alt||"",style:d(a),draggable:!0,onDragStart:()=>{return t=e,void(n.current=t);var t},onDragEnter:()=>{return t=e,void(o.current=t);var t},onDragEnd:l,onClick:()=>s&&s(e),title:"Drag to reorder. Click to preview."},t.id)))}):null},c="instagram";(0,t.registerPlugin)("post-to-instagram",{render:()=>{const{is_configured:t,is_authenticated:d,auth_url:u,i18n:p,auth_redirect_status:g,app_id:h,post_id:m}=pti_data,[w,_]=(0,r.useState)(t),[f,x]=(0,r.useState)(d),[v,S]=(0,r.useState)(u),[y,b]=(0,r.useState)(!0),[j,I]=(0,r.useState)(!1),[C,E]=(0,r.useState)(h||""),[A,P]=(0,r.useState)([]),[D,k]=(0,r.useState)(!1),[F,R]=(0,r.useState)(null),B=A.length>0&&A[0].url&&A[0].id?(()=>{const t=A[0];return t.width&&t.height?t.width/t.height:1})():1,L=(t=!1)=>{b(!0),wp.apiFetch({path:"pti/v1/auth/status",method:"GET"}).then((e=>{_(e.is_configured),x(e.is_authenticated),S(e.auth_url||"#"),E(e.app_id||""),b(!1),t&&e.is_authenticated})).catch((e=>{b(!1),console.error("Error checking auth status:",e),t&&alert(p.generic_auth_error||"Error checking authentication status.")}))};(0,r.useEffect)((()=>{const t=t=>{t.data&&"pti_auth_complete"===t.data.type&&(t.data.success?(L(!0),window.oauthWindow&&!window.oauthWindow.closed&&window.oauthWindow.close()):alert(p.auth_failed+(t.data.message?"\\n"+t.data.message:"")))};return window.addEventListener("message",t),()=>window.removeEventListener("message",t)}),[p]),(0,r.useEffect)((()=>{if(g){if("success"===g)L(!0);else{let t=p.auth_failed;p[g]?t=p[g]:"1"!==g&&(t+=` (Details: ${g})`),alert(t)}if(window.history.replaceState){const t=new URL(window.location.href);t.searchParams.delete("pti_auth_success"),t.searchParams.delete("pti_auth_error"),window.history.replaceState({path:t.href},"",t.href)}}}),[g,p]);(0,r.useEffect)((()=>{L()}),[]);let T;return T=y?(0,i.jsx)("p",{children:(0,a.__)("Loading status...","post-to-instagram")}):!w||j?(0,i.jsx)(n,{isConfigured:w,isAuthenticated:f,authUrl:v,i18n:p,isLoading:y,onAuthStatusChange:L,showEdit:j,setShowEdit:I,savedAppId:C}):f?(0,i.jsxs)(r.Fragment,{children:[(0,i.jsx)("p",{children:(0,a.__)("Ready to post to Instagram!","post-to-instagram")}),(0,i.jsx)(s.Button,{isPrimary:!0,onClick:()=>k(!0),children:p.select_images||"Select Images"}),(0,i.jsx)("div",{style:{margin:"8px 0",color:"#b26a00",fontSize:12},children:(0,a.__)("All images will be cropped to match the aspect ratio of the first image in your selection, per Instagram's requirements.","post-to-instagram")}),(0,i.jsx)(l,{images:A,setImages:P,aspectRatio:B,onPreview:t=>R(t)}),null!==F&&(0,i.jsx)("div",{style:{marginTop:12,color:"#888"},children:(0,a.__)("(Image preview modal coming soon)","post-to-instagram")}),(0,i.jsx)(s.Button,{isSecondary:!0,onClick:()=>alert("Disconnect TBD"),style:{marginLeft:8},children:p.disconnect_instagram||"Disconnect"}),D&&(0,i.jsx)(o,{selectedImages:A,setSelectedImages:P,postId:m,onClose:()=>k(!1)})]}):(0,i.jsxs)(r.Fragment,{children:[(0,i.jsx)("p",{children:(0,a.__)("Connect your Instagram account to start posting.","post-to-instagram")}),(0,i.jsx)(s.Button,{isPrimary:!0,onClick:()=>{if(w)if(v&&"#"!==v){window.oauthWindow=window.open(v,"ptiOAuthConnect","width=600,height=700");const t=setInterval((()=>{window.oauthWindow&&window.oauthWindow.closed&&(clearInterval(t),console.log("OAuth window closed by user or completed, re-checking auth status."),L(!0))}),1e3)}else alert(p.generic_auth_error||"Authentication URL not available.");else alert(p.not_configured_for_auth||"App not configured.")},disabled:y||"#"===v,children:p.connect_instagram||"Connect to Instagram"}),(0,i.jsx)(s.Button,{isSecondary:!0,onClick:()=>I(!0),style:{marginLeft:8},children:(0,a.__)("Edit API Credentials","post-to-instagram")})]}),(0,i.jsxs)(r.Fragment,{children:[(0,i.jsx)(e.PluginSidebarMoreMenuItem,{target:"post-to-instagram-sidebar",icon:c,children:p.post_to_instagram||"Post to Instagram"}),(0,i.jsx)(e.PluginSidebar,{name:"post-to-instagram-sidebar",title:p.post_to_instagram||"Post to Instagram",icon:c,children:(0,i.jsx)(s.PanelBody,{children:T})})]})},icon:c})})();
//# sourceMappingURL=post-editor.js.map